<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageRAG Local Testing</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.info {
            background: #e7f3ff;
            color: #0066cc;
            border-left: 4px solid #007bff;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #results {
            max-height: 600px;
            overflow-y: auto;
        }
        .result-item {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .result-item:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .result-score {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .result-path {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .result-text {
            color: #333;
            line-height: 1.6;
        }
        .chunk-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .chunk-item {
            padding: 8px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .chunk-item:hover {
            background: #e0e0e0;
        }
        .rag-highlight {
            background-color: #ffff00 !important;
            transition: background-color 0.3s ease !important;
            border: 2px solid #ffd700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5) !important;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üîç PageRAG Local Testing</h1>
    <p class="subtitle">Test the RAG system without loading the Chrome extension</p>
    
    <div class="controls">
        <input type="text" id="query-input" placeholder="Enter your query (e.g., 'What are the benefits?')" />
        <button id="search-btn">Search</button>
        <button id="init-btn">Initialize</button>
        <button id="clear-btn">Clear</button>
    </div>
    
    <div id="status" class="status info">Ready to initialize. Click "Initialize" to start.</div>
    
    <div class="container">
        <div class="panel">
            <h2>Search Results</h2>
            <div id="results">
                <p style="color: #666;">No results yet. Initialize and search to see results.</p>
            </div>
        </div>
        
        <div class="panel">
            <h2>Console & Chunks</h2>
            <div>
                <h3>Chunks (<span id="chunk-count">0</span>)</h3>
                <div id="chunks" class="chunk-list"></div>
            </div>
            <div style="margin-top: 20px;">
                <h3>Console Output</h3>
                <div id="console-output"></div>
            </div>
        </div>
    </div>
    
    <!-- Test Content -->
    <div style="margin-top: 40px; padding: 20px; background: white; border-radius: 8px;">
        <h2>Test Content (for testing on this page)</h2>
        <main>
            <h1>Main Title - Company Benefits</h1>
            <p>This is the main content area. It contains important information about the company benefits and policies.</p>
            
            <h2>Health Insurance</h2>
            <p>We offer comprehensive health insurance plans including medical, dental, and vision coverage. Our plans cover 100% of premiums for employees.</p>
            
            <h3>Medical Coverage</h3>
            <p>Full medical coverage with low deductibles and copays. Access to a wide network of healthcare providers.</p>
            
            <h2>Retirement Plans</h2>
            <p>401k retirement plans with company matching up to 6% of your salary. Immediate vesting for all contributions.</p>
            
            <h2>Work-Life Balance</h2>
            <p>Flexible work arrangements including remote work options, unlimited PTO, and flexible hours.</p>
            
            <h3>Remote Work</h3>
            <p>Work from anywhere with our fully remote-friendly policy. We provide all necessary equipment and support.</p>
            
            <h2>Professional Development</h2>
            <p>Annual learning budget, conference attendance, and mentorship programs to help you grow your career.</p>
        </main>
    </div>

    <!-- Load the test bundle -->
    <script src="../dist/test-bundle.js"></script>
    
    <script>
        let rag = null;
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;

        // Capture console output
        function captureConsole() {
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                logToOutput('LOG', args.join(' '));
            };
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                logToOutput('ERROR', args.join(' '));
            };
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                logToOutput('WARN', args.join(' '));
            };
        }

        function logToOutput(level, message) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = level === 'ERROR' ? '#f48771' : level === 'WARN' ? '#dcdcaa' : '#4ec9b0';
            output.innerHTML += `<span style="color: ${color}">[${timestamp}] [${level}]</span> ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateChunks() {
            if (!rag) return;
            const chunks = rag.getChunks();
            const count = document.getElementById('chunk-count');
            const list = document.getElementById('chunks');
            
            count.textContent = chunks.length;
            
            if (chunks.length === 0) {
                list.innerHTML = '<p style="color: #666;">No chunks yet</p>';
                return;
            }
            
            list.innerHTML = chunks.map((chunk, i) => `
                <div class="chunk-item" onclick="highlightChunk(${i})">
                    <strong>${chunk.id}</strong><br>
                    <small>${chunk.metadata.headingPath.join(' > ') || 'No heading'}</small><br>
                    <small style="color: #666;">${chunk.metadata.raw_text.substring(0, 100)}...</small>
                </div>
            `).join('');
        }

        window.highlightChunk = function(index) {
            if (!rag) return;
            const chunks = rag.getChunks();
            const chunk = chunks[index];
            if (chunk.metadata.cssSelector) {
                const element = document.querySelector(chunk.metadata.cssSelector);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.classList.add('rag-highlight');
                    setTimeout(() => element.classList.remove('rag-highlight'), 3000);
                }
            }
        };

        document.getElementById('init-btn').addEventListener('click', async () => {
            try {
                updateStatus('Initializing PageRAG... This may take a minute on first load.', 'warning');
                document.getElementById('init-btn').disabled = true;
                
                rag = new PageRAG();
                await rag.init();
                
                updateStatus(`‚úÖ Initialized successfully! Found ${rag.getChunks().length} chunks.`, 'success');
                updateChunks();
                document.getElementById('init-btn').disabled = false;
            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('init-btn').disabled = false;
                console.error(error);
            }
        });

        document.getElementById('search-btn').addEventListener('click', async () => {
            if (!rag) {
                updateStatus('Please initialize first!', 'warning');
                return;
            }

            const query = document.getElementById('query-input').value.trim();
            if (!query) {
                updateStatus('Please enter a query', 'warning');
                return;
            }

            try {
                updateStatus('Searching...', 'info');
                document.getElementById('search-btn').disabled = true;
                
                const results = await rag.search(query, { limit: 10 });
                
                if (results.length === 0) {
                    document.getElementById('results').innerHTML = '<p style="color: #666;">No results found. Try a different query.</p>';
                    updateStatus('No results found', 'warning');
                } else {
                    displayResults(results);
                    updateStatus(`Found ${results.length} results`, 'success');
                    
                    // Highlight first result
                    if (results[0].highlightElement) {
                        rag.highlightResult(results[0]);
                    }
                }
                
                document.getElementById('search-btn').disabled = false;
            } catch (error) {
                updateStatus(`Search error: ${error.message}`, 'error');
                document.getElementById('search-btn').disabled = false;
                console.error(error);
            }
        });

        document.getElementById('query-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('search-btn').click();
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            document.getElementById('results').innerHTML = '<p style="color: #666;">No results yet.</p>';
            document.getElementById('console-output').innerHTML = '';
            document.getElementById('query-input').value = '';
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = results.map((result, i) => `
                <div class="result-item" onclick="highlightResult(${i})">
                    <div class="result-header">
                        <strong>Result ${i + 1}</strong>
                        <span class="result-score">${(result.score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="result-path">
                        ${result.chunk.metadata.headingPath.join(' > ') || 'No heading path'}
                    </div>
                    <div class="result-text">
                        ${result.chunk.metadata.raw_text.substring(0, 300)}${result.chunk.metadata.raw_text.length > 300 ? '...' : ''}
                    </div>
                </div>
            `).join('');
        }

        window.highlightResult = function(index) {
            if (!rag) return;
            const query = document.getElementById('query-input').value.trim();
            rag.search(query, { limit: 10 }).then(results => {
                if (results[index] && results[index].highlightElement) {
                    rag.highlightResult(results[index]);
                }
            });
        };

        // Start capturing console
        captureConsole();
        
        // Check if PageRAG is available
        if (typeof PageRAG !== 'undefined') {
            updateStatus('PageRAG loaded! Click "Initialize" to start.', 'info');
        } else {
            updateStatus('‚ö†Ô∏è PageRAG not loaded. Make sure test-bundle.js is built.', 'error');
        }
    </script>
</body>
</html>

